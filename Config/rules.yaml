# ScholarshipOps Triage Rules Configuration
# YAML 驅動的規則引擎配置

# ============================================
# 硬淘汰規則 (Hard Reject Rules)
# ============================================

hard_reject_rules:
  # === Fee Status Gate ===
  - id: "E-FEE-001"
    name: "Home Fee Status Only"
    stage: "eligibility"
    description: "Requires Home/UK fee status"
    when:
      any_regex:
        - "(?i)home\\s*fee\\s*status"
        - "(?i)UK\\s*fee\\s*status"
        - "(?i)\\bRUK\\b"
        - "(?i)home\\s*students?\\s*only"
        - "(?i)UK\\s*residents?\\s*only"
        - "(?i)ordinarily\\s*resident\\s*in\\s*(the\\s*)?UK"
        - "(?i)settled\\s*status"
        - "(?i)domiciled\\s*in\\s*(the\\s*)?UK"
    action:
      bucket: "C"
      reason: "Requires Home/UK fee status; not applicable to international/Taiwan applicants."

  # === Degree Level Gate ===
  - id: "E-LEVEL-UG-001"
    name: "Undergraduate Only"
    stage: "eligibility"
    description: "Undergraduate-only scholarship"
    when:
      any_regex:
        - "(?i)undergraduate\\s*(only|students?)"
        - "(?i)bachelor'?s?\\s*(only|students?|degree)"
        - "(?i)\\bUG\\s*only\\b"
        - "(?i)foundation\\s*year\\s*only"
        - "(?i)pre-sessional\\s*only"
    action:
      bucket: "C"
      reason: "Undergraduate-only scholarship."

  - id: "E-LEVEL-PHD-001"
    name: "PhD Only"
    stage: "eligibility"
    description: "PhD/Doctoral-only scholarship"
    when:
      any_regex:
        - "(?i)\\bPhD\\s*(only|students?|candidates?)"
        - "(?i)doctoral\\s*(only|students?|candidates?)"
        - "(?i)postdoc(toral)?\\s*(only|fellowship)"
        - "(?i)research\\s*degree\\s*only"
        - "(?i)\\bMPhil\\s*only\\b"
    action:
      bucket: "C"
      reason: "PhD/Doctoral-only scholarship."

  # === Special Identity Gate ===
  - id: "E-IDENTITY-001"
    name: "Care Leaver"
    stage: "eligibility"
    description: "Care leaver only"
    when:
      any_regex:
        - "(?i)care\\s*leaver"
        - "(?i)looked\\s*after\\s*child"
        - "(?i)foster\\s*care"
    action:
      bucket: "C"
      reason: "Care leaver only scholarship."

  - id: "E-IDENTITY-002"
    name: "Refugee/Asylum"
    stage: "eligibility"
    description: "Refugee or asylum seeker only"
    when:
      any_regex:
        - "(?i)\\brefugee\\b"
        - "(?i)asylum\\s*seeker"
        - "(?i)sanctuary\\s*scholarship"
        - "(?i)displaced\\s*persons?"
    action:
      bucket: "C"
      reason: "Refugee/Asylum seeker only scholarship."

  - id: "E-IDENTITY-003"
    name: "Armed Forces"
    stage: "eligibility"
    description: "Armed forces/veteran only"
    when:
      any_regex:
        - "(?i)armed\\s*forces"
        - "(?i)\\bveteran\\b"
        - "(?i)service\\s*leaver"
        - "(?i)military\\s*personnel"
    action:
      bucket: "C"
      reason: "Armed forces/veteran only scholarship."

  - id: "E-IDENTITY-004"
    name: "Local Council"
    stage: "eligibility"
    description: "Local council residents only"
    when:
      any_regex:
        - "(?i)local\\s*council\\s*residents?"
        - "(?i)local\\s*authority\\s*residents?"
        - "(?i)\\bScottish\\s*domicile\\b"
        - "(?i)\\bWelsh\\s*domicile\\b"
    action:
      bucket: "C"
      reason: "Local council/authority residents only."

  # === US Residency Gate ===
  - id: "E-RESIDENCY-001"
    name: "US State/County Residency Required"
    stage: "eligibility"
    description: "Requires US state or county residency - not applicable for international students"
    when:
      any_regex:
        - "(?i)resident\\s+of\\s+(the\\s+)?state\\s+of"
        - "(?i)resident\\s+of\\s+\\w+\\s+county"
        - "(?i)Washington\\s+State\\s+resident"
        - "(?i)high\\s+school\\s+seniors?\\s+in\\s+\\w+"
        - "(?i)U\\.?S\\.?\\s+citizen(ship)?\\s*(or\\s+permanent\\s+resident)?"
        - "(?i)must\\s+be\\s+a\\s+resident\\s+of"
        - "(?i)\\bSeattle\\s+Foundation\\b"
        - "(?i)\\bcommunity\\s+foundation\\b.*\\b(state|county|local)\\b"
        - "(?i)\\b(California|Texas|Florida|New York|Illinois|Pennsylvania|Ohio|Georgia|Michigan|Arizona)\\s+residents?\\b"
    action:
      bucket: "C"
      reason: "Requires US state/county residency - not applicable for Taiwan"

  # === EU Only Gate ===
  # === EU Only Gate ===
  - id: "E-REGION-EU-001"
    name: "EU Only"
    stage: "eligibility"
    description: "EU-only scholarship"
    when:
      any_regex:
        - "(?i)EU\\s+students?\\s+only"
        - "(?i)European\\s+Union\\s+students?\\s+only"
        - "(?i)available\\s+to\\s+EU\\s+nationals?\\s+only"
    action:
      bucket: "C"
      reason: "EU-only scholarship."

  # === Country Eligibility Gate ===
  - id: "E-COUNTRY-001"
    name: "Taiwan Not Eligible (Explicit)"
    stage: "eligibility"
    description: "Taiwan is explicitly not in the eligible countries list"
    when:
      is_taiwan_eligible: false
      taiwan_eligibility_confidence: "explicit_list"
    action:
      bucket: "C"
      reason: "Taiwan not in eligible countries list (explicit)."

  # === Timeline Gate ===
  - id: "T-DEAD-PAST-001"
    name: "Deadline Passed"
    stage: "timeline"
    description: "Deadline has passed - saved for next cycle"
    when:
      deadline:
        lt_today: true
    action:
      bucket: "X"
      reason: "Deadline passed - saved for next cycle"

  - id: "T-TIMELINE-001"
    name: "Wrong Intake Cycle (Pre-entry Only)"
    stage: "timeline"
    description: "Deadline is after target study start date - wrong intake cycle for pre-entry funding"
    when:
      deadline:
        gt_study_start: true
        safety_margin_days: 60
      not_any_regex:
        - "(?i)current\\s+students?"
        - "(?i)enrolled\\s+students?"
        - "(?i)after\\s+enrol"
        - "(?i)registered\\s+students?"
    action:
      bucket: "C"
      reason: "Deadline after study start date (Sep 2026) - wrong intake cycle for pre-entry funding."

  # === Scam Detection ===
  - id: "S-SCAM-001"
    name: "Scholarship Application Fee Required"
    stage: "trust"
    description: "Scholarship requires payment to apply"
    when:
      all_regex:
        - "(?i)scholarship"
        - "(?i)(processing\\s*fee|pay\\s*to\\s*apply|application\\s*fee)"
    action:
      bucket: "C"
      reason: "Scholarship application fee required - likely scam."

  - id: "S-SCAM-002"
    name: "Guaranteed/Money Back"
    stage: "trust"
    description: "Suspicious marketing language"
    when:
      any_regex:
        - "(?i)\\bguaranteed\\b"
        - "(?i)money\\s*back"
        - "(?i)exclusive\\s*list"
        - "(?i)act\\s*now"
        - "(?i)limited\\s*time\\s*offer"
    action:
      bucket: "C"
      reason: "Scam-like marketing language detected."

  # === Content Type Gate ===
  - id: "C-INFO-001"
    name: "Information/Guide Page (Not Scholarship)"
    stage: "content"
    description: "Page is informational/guide content, not an actual scholarship"
    when:
      any_regex:
        - "(?i)how\\s+to\\s+(find|apply\\s+for|get)"
        - "(?i)guide\\s+to\\s+(finding|applying)"
        - "(?i)tips?\\s+for\\s+(finding|applying)"
        - "(?i)types?\\s+of\\s+scholarships?"
        - "(?i)what\\s+are\\s+scholarships?"
        - "(?i)explaining\\s+scholarships?"
      not_any_regex:
        - "(?i)apply\\s+now"
        - "(?i)application\\s+form"
        - "(?i)eligibility\\s+criteria"
    action:
      bucket: "C"
      reason: "Information/guide page, not an actual scholarship application page."

  - id: "C-GOV-DEGREE-001"
    name: "GOV.UK Degree Recognition (Not Funding)"
    stage: "content"
    description: "GOV.UK page about degree recognition, not funding"
    when:
      any_regex:
        - "(?i)award\\s+a\\s+degree"
        - "(?i)recognised\\s+awards?"
        - "(?i)recognised\\s+uk\\s+degrees?"
        - "(?i)degree\\s+recognition"
        - "(?i)recognised\\s+qualifications?"
        - "(?i)Office\\s+for\\s+Students"
    action:
      bucket: "C"
      reason: "GOV.UK degree recognition page, not funding-related."

# ============================================
# 軟降權規則 (Soft Downgrade Rules)
# ============================================

soft_downgrade_rules:
  - id: "B-COUNTRY-UNK-001"
    name: "Taiwan Eligibility Unknown"
    stage: "eligibility"
    description: "Taiwan eligibility unknown; needs verification"
    when:
      is_taiwan_eligible: "unknown"
    action:
      bucket: "B"
      reason: "Taiwan eligibility unknown; needs verification."

  - id: "B-NONTARGET-001"
    name: "Non-Target (Needs Portability Proof)"
    stage: "eligibility"
    description: "Not from Glasgow and portability to UK not proven"
    when:
      is_directory_page: false
      not_any_regex:
        - "(?i)gla\\.ac\\.uk"
        - "(?i)glasgow\\.ac\\.uk"
        - "(?i)University\\s*of\\s*Glasgow"
        - "(?i)\\bGlasgow\\b.*scholarship"
        - "(?i)study\\s+in\\s+the\\s+UK"
        - "(?i)any\\s+university"
        - "(?i)any\\s+UK\\s+universit"
        - "(?i)postgraduate\\s+study\\s+in\\s+the\\s+UK"
        - "(?i)overseas\\s+master"
        - "(?i)\\bChevening\\b"
        - "(?i)\\bGates\\s*Cambridge\\b"
        - "(?i)\\bRhodes\\s*Scholar"
        - "(?i)\\bMarshall\\s*Scholar"
        - "(?i)\\bCommonwealth\\s*Scholar"
        - "(?i)\\bRotary\\s*Foundation\\b"
        - "(?i)\\bFulbright\\b"
        - "(?i)international\\s+students?\\s+at\\s+UK\\s+universit"
    action:
      bucket: "B"
      reason: "Non-target scholarship; portability to UK not proven."

  - id: "B-INCOURSE-001"
    name: "In-Course Funding"
    stage: "timeline"
    description: "Scholarship for enrolled students (apply after enrolment)"
    when:
      deadline:
        gt_study_start: true
      any_regex:
        - "(?i)current\\s+students?"
        - "(?i)enrolled\\s+students?"
        - "(?i)after\\s+enrol"
        - "(?i)registered\\s+students?"
    action:
      bucket: "B"
      reason: "In-course funding (apply after enrolment)."

  - id: "B-LINK-001"
    name: "Rate Limited"
    stage: "link_health"
    description: "URL returned 403/429"
    when:
      http_status:
        any_of: [403, 429]
    action:
      bucket: "B"
      reason: "Rate limited or blocked; needs retry."

  - id: "B-DEADLINE-001"
    name: "Deadline Missing"
    stage: "timeline"
    description: "No deadline specified"
    when:
      deadline:
        is_null: true
    action:
      bucket: "B"
      add_to_watchlist: true
      reason: "Deadline missing; added to watchlist."

  - id: "B-ELIGIBILITY-001"
    name: "Eligibility Unclear"
    stage: "eligibility"
    description: "Eligibility criteria unclear"
    when:
      any_regex:
        - "(?i)eligible\\s*countries\\s*vary"
        - "(?i)check\\s*eligibility"
        - "(?i)subject\\s*to\\s*change"
    action:
      bucket: "B"
      reason: "Eligibility unclear; needs verification."

  - id: "B-EFFORT-001"
    name: "High Effort"
    stage: "effort"
    description: "High application effort"
    when:
      effort_score:
        gt: 60
    action:
      bucket: "B"
      reason: "High application effort; consider if award justifies cost."

  - id: "B-GPA-UNK-001"
    name: "GPA scale unclear"
    stage: "eligibility"
    description: "Scholarship mentions GPA requirement; scale or conversion unclear"
    when:
      any_regex:
        - "(?i)gpa\\s*(of|>|>=|minimum)?\\s*[\\d.]+"
        - "(?i)grade\\s*point\\s*average"
        - "(?i)minimum\\s*[\\d.]+\\s*(gpa|grade)"
    action:
      bucket: "B"
      reason: "GPA requirement mentioned; verify scale/conversion."

  - id: "B-EFFORT-VIDEO-001"
    name: "Requires Video Essay (Unprepared)"
    stage: "effort"
    description: "Scholarship requires video essay but user may not have prepared it"
    when:
      any_regex:
        - "(?i)video\\s+essay"
        - "(?i)video\\s+statement"
        - "(?i)video\\s+interview"
    action:
      effort_add: 15
      bucket: "B"
      reason: "Requires video essay (not yet prepared)."

# ============================================
# 加分規則 (Positive Scoring Rules)
# ============================================

positive_scoring_rules:
  - id: "P-TARGET-001"
    name: "Target University"
    stage: "scoring"
    description: "Target university match"
    when:
      any_regex:
        - "(?i)University\\s*of\\s*Glasgow"
        - "(?i)\\bGlasgow\\b"
    action:
      score_add: 50
      reason: "Target university (Glasgow)."

  - id: "P-INTL-001"
    name: "International Students"
    stage: "scoring"
    description: "Open to international students"
    when:
      any_regex:
        - "(?i)international\\s*students?"
        - "(?i)overseas\\s*students?"
        - "(?i)all\\s*nationalities"
        - "(?i)open\\s*to\\s*all"
    action:
      score_add: 30
      reason: "Open to international students."

  - id: "P-TAIWAN-001"
    name: "Taiwan Eligible"
    stage: "scoring"
    description: "Taiwan explicitly eligible"
    when:
      any_regex:
        - "(?i)\\bTaiwan\\b"
        - "(?i)Taiwanese"
        - "(?i)Republic\\s*of\\s*China"
    action:
      score_add: 40
      reason: "Taiwan explicitly eligible."

  - id: "P-LEVEL-001"
    name: "Postgraduate Taught"
    stage: "scoring"
    description: "Postgraduate taught level match"
    when:
      any_regex:
        - "(?i)postgraduate\\s*taught"
        - "(?i)\\bPGT\\b"
        - "(?i)taught\\s*master'?s?"
        - "(?i)\\bMSc\\b"
        - "(?i)\\bMA\\b"
    action:
      score_add: 25
      reason: "Postgraduate taught level."

  - id: "P-FULL-001"
    name: "Full Funding"
    stage: "scoring"
    description: "Full tuition or fully funded"
    when:
      any_regex:
        - "(?i)full\\s*tuition"
        - "(?i)fully\\s*funded"
        - "(?i)full\\s*cost"
        - "(?i)covers?\\s*all\\s*fees?"
        - "(?i)100%\\s*tuition"
    action:
      score_add: 35
      reason: "Full funding available."

  - id: "P-MERIT-001"
    name: "Merit Based"
    stage: "scoring"
    description: "Merit-based scholarship"
    when:
      any_regex:
        - "(?i)\\bmerit\\b"
        - "(?i)academic\\s*excellence"
        - "(?i)outstanding\\s*academic"
        - "(?i)high\\s*achiever"
    action:
      score_add: 20
      reason: "Merit-based (good for high GPA)."

  - id: "P-AUTO-001"
    name: "Auto Considered"
    stage: "scoring"
    description: "Automatically considered"
    when:
      any_regex:
        - "(?i)auto(matically)?\\s*consider"
        - "(?i)no\\s*separate\\s*application"
        - "(?i)considered\\s*automatically"
    action:
      score_add: 25
      effort_reduce: 30
      reason: "Automatically considered; no extra application needed."

  - id: "P-COMPUTING-001"
    name: "Computing/Software"
    stage: "scoring"
    description: "Computing or software related"
    when:
      any_regex:
        - "(?i)computer\\s*science"
        - "(?i)computing"
        - "(?i)software"
        - "(?i)information\\s*technology"
        - "(?i)data\\s*science"
        - "(?i)\\bI\\.T\\.\\b"
    action:
      score_add: 15
      reason: "Computing/Software field match."

# ============================================
# 期望值計算權重
# ============================================

scoring_weights:
  award_value: 0.35
  probability: 0.35
  timeline: 0.20
  effort_penalty: 0.20
  risk_penalty: 0.40

# ============================================
# 分桶閾值
# ============================================

bucket_thresholds:
  A:
    min_final_score: 100
    min_trust_tier: "B"
    max_effort_score: 60
  B:
    min_final_score: 50
    min_trust_tier: "C"
  # C: 所有其他或被硬淘汰的
